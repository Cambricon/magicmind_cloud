image: yellow.hub.cambricon.com/magicmind/release/x86_64/magicmind:1.0.1-x86_64-ubuntu18.04-py_3_7

report-result:
    stage: .post
    tags: 
        - test_runner
    script:
        - pip install -r test/requirement.txt
        - python test/show_table.py
    artifacts:
        paths:
            - ${CI_PROJECT_DIR}/benchmark.csv

.network_test:
    stage: test
    tags: 
        - test_runner
    retry: 2
    script:
        - echo "export http_proxy=http://proxy.cambricon.com:8080" >> ~/.bashrc
        - echo "export https_proxy=http://proxy.cambricon.com:8080" >> ~/.bashrc
        - source ~/.bashrc
        # pip install 
        - pip install --upgrade pip
        - pip install nvidia-pyindex
        - pip install -r test/requirement.txt
        # start test
        - cd ${TEST_PROJ_DIR}
        - source env.sh
        - mkdir -p data/models
        - mkdir -p /nfsdata/modelzoo/datasets
        # ln models/datasets/codes
        - cp -r /zoo_ci/models/${TEST_PROJ_DIR##*/}/* data/models
        - ln -sf /zoo_ci/datasets/${DATASETS_PATH##*/} ${DATASETS_PATH}
        - if [ -d /zoo_ci/codes/${TEST_PROJ_DIR##*/} ]; then cp -r /zoo_ci/codes/${TEST_PROJ_DIR##*/}/* export_model; fi
        - if [ -f requirement.txt ]; then pip install -r requirement.txt; fi
        #- if [ -f benchmark/perf.sh ]; then bash benchmark/perf.sh; fi
        #- if [ -f benchmark/eval.sh ]; then bash benchmark/eval.sh; fi
        - bash run.sh
    artifacts:
        paths:
            - ${TEST_PROJ_DIR}/benchmark/benchmark.csv
            - ${CI_PROJECT_DIR}/test/*.csv
